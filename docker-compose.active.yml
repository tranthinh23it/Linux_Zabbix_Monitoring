version: '3.8'

services:
  # MySQL Database
  mysql-server:
    image: mysql:8.0
    container_name: zabbix-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: zabbix
      MYSQL_USER: zabbix
      MYSQL_PASSWORD: zabbix_password
      MYSQL_ROOT_PASSWORD: root_password
    volumes:
      - mysql_data:/var/lib/mysql
      - ./configs/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    networks:
      - zabbix-net
    ports:
      - "3306:3306"
    command: 
      - mysqld
      - --character-set-server=utf8
      - --collation-server=utf8_bin
      - --default-authentication-plugin=mysql_native_password

  # Zabbix Server
  zabbix-server:
    image: zabbix/zabbix-server-mysql:alpine-6.4-latest
    container_name: zabbix-server
    restart: unless-stopped
    environment:
      DB_SERVER_HOST: mysql-server
      MYSQL_DATABASE: zabbix
      MYSQL_USER: zabbix
      MYSQL_PASSWORD: zabbix_password
      MYSQL_ROOT_PASSWORD: root_password
      ZBX_ENABLE_SNMP_TRAPS: "true"
      ZBX_STARTPOLLERS: 5
      ZBX_STARTPOLLERSUNREACHABLE: 1
      ZBX_STARTTRAPPERS: 5
      ZBX_STARTPINGERS: 1
      ZBX_STARTDISCOVERERS: 1
      ZBX_STARTHTTPPOLLERS: 1
      ZBX_STARTTIMERS: 1
      ZBX_STARTESCALATORS: 1
      ZBX_STARTALERTERS: 3
      ZBX_HOUSEKEEPINGFREQUENCY: 1
      ZBX_MAXHOUSEKEEPERDELETETIME: 5
      ZBX_SENDERFREQUENCY: 30
      ZBX_CACHESIZE: 8M
      ZBX_CACHEUPDATEFREQUENCY: 60
      ZBX_STARTDBSYNCERS: 4
      ZBX_HISTORYCACHESIZE: 16M
      ZBX_HISTORYINDEXCACHESIZE: 4M
      ZBX_TRENDCACHESIZE: 4M
      ZBX_VALUECACHESIZE: 8M
    volumes:
      - zabbix_server_data:/var/lib/zabbix
      - ./configs/zabbix/alertscripts:/usr/lib/zabbix/alertscripts
      - ./configs/zabbix/externalscripts:/usr/lib/zabbix/externalscripts
      - ./ssl:/var/lib/zabbix/ssl
    networks:
      - zabbix-net
    ports:
      - "10051:10051"
    depends_on:
      - mysql-server

  # Zabbix Web Interface
  zabbix-web:
    image: zabbix/zabbix-web-nginx-mysql:alpine-6.4-latest
    container_name: zabbix-web
    restart: unless-stopped
    environment:
      ZBX_SERVER_HOST: zabbix-server
      DB_SERVER_HOST: mysql-server
      MYSQL_DATABASE: zabbix
      MYSQL_USER: zabbix
      MYSQL_PASSWORD: zabbix_password
      MYSQL_ROOT_PASSWORD: root_password
      PHP_TZ: Asia/Ho_Chi_Minh
      ZBX_SERVER_NAME: "Zabbix Monitoring System"
      ZBX_MAXEXECUTIONTIME: 600
      ZBX_MEMORYLIMIT: 256M
      ZBX_POSTMAXSIZE: 32M
      ZBX_UPLOADMAXFILESIZE: 16M
      ZBX_MAXINPUTTIME: 300
    volumes:
      - ./ssl:/etc/ssl/nginx
      - ./configs/nginx/nginx.conf:/etc/nginx/nginx.conf
    networks:
      - zabbix-net
    ports:
      - "80:8080"
      - "443:8443"
    depends_on:
      - mysql-server
      - zabbix-server

  # Zabbix Agent (for monitoring Zabbix server itself)
  zabbix-agent:
    image: zabbix/zabbix-agent:alpine-6.4-latest
    container_name: zabbix-agent-server
    restart: unless-stopped
    environment:
      ZBX_HOSTNAME: "Zabbix Server"
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
      ZBX_PASSIVE_ALLOW: "true"
      ZBX_ACTIVE_ALLOW: "true"
      ZBX_LOADMODULE: dummy1.so,dummy2.so
      ZBX_DEBUGLEVEL: 3
      ZBX_TIMEOUT: 4
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /dev:/host/dev:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - zabbix-net
    ports:
      - "10050:10050"
    privileged: true
    pid: host
    depends_on:
      - zabbix-server

  # Grafana for advanced visualization
  grafana:
    image: grafana/grafana:latest
    container_name: zabbix-grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin123
      GF_INSTALL_PLUGINS: alexanderzobnin-zabbix-app
      GF_PLUGINS_ALLOW_LOADING_UNSIGNED_PLUGINS: alexanderzobnin-zabbix-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./configs/grafana/provisioning:/etc/grafana/provisioning
      - ./dashboards/grafana:/var/lib/grafana/dashboards
    networks:
      - zabbix-net
    ports:
      - "3000:3000"
    depends_on:
      - zabbix-server

  # Nginx Proxy for SSL termination
  nginx-proxy:
    image: nginx:alpine
    container_name: zabbix-proxy
    restart: unless-stopped
    volumes:
      - ./configs/nginx/proxy.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    networks:
      - zabbix-net
    ports:
      - "8080:80"
      - "8443:443"
    depends_on:
      - zabbix-web
      - grafana

  # Redis for caching
  redis:
    image: redis:alpine
    container_name: zabbix-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - zabbix-net
    ports:
      - "6379:6379"

  # Elasticsearch for log analysis
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    container_name: zabbix-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - zabbix-net
    ports:
      - "9200:9200"

  # Fluentd for log collection
  fluentd:
    build: ./configs/fluentd
    container_name: zabbix-fluentd
    restart: unless-stopped
    volumes:
      - ./configs/fluentd/fluent.conf:/fluentd/etc/fluent.conf
      - /var/log:/var/log:ro
    networks:
      - zabbix-net
    ports:
      - "24224:24224"
    depends_on:
      - elasticsearch

volumes:
  mysql_data:
  zabbix_server_data:
  grafana_data:
  redis_data:
  elasticsearch_data:

networks:
  zabbix-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16